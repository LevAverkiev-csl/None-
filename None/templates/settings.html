{% extends "base.html" %}

{% block content %}
<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script>
        // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Flask –≤ JavaScript
        const userSettings = {
            darkMode: {{ current_user.dark_mode|tojson|default('false') }}
        };
    </script>
    <script src="{{ url_for('static', filename='dark_mode.js') }}"></script>
    <style>
        /* CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π –∏ —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
        :root {
            --bg-color: #d7ffd8;
            --text-color: #000000;
            --container-bg: #ffffff;
            --border-color: #ccc;
            --button-bg: #5cb85c;
            --button-hover-bg: #4cae4c;
            --upload-icon-color: #5181b8;
            --delete-btn-bg: #dc3545;
            --delete-btn-hover-bg: #c82333;
        }

        body.dark-mode {
            --bg-color: #121212;
            --text-color: #ffffff; /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
            --container-bg: #2d2d2d; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω */
            --border-color: #444;
            --button-bg: #2196F3;
            --button-hover-bg: #1976D2;
            --upload-icon-color: #2196F3;
            --delete-btn-bg: #dc3545;
            --delete-btn-hover-bg: #c82333;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color); /* –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .nav-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .nav {
            display: flex;
            list-style-type: none;
            padding: 0;
            margin: 0;
            justify-content: center;
            background-color: var(--nav-bg);
            padding: 10px 0;
        }

        .nav-item {
            margin: 0 5px;
        }

        .nav-link {
            text-decoration: none;
            color: var(--nav-text-color);
            padding: 10px;
        }

        .nav-link img {
            width: 30px;
            height: 30px;
        }


        .settings-container {
            flex: 1;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: var(--container-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
            width: 100%;
        }

        .avatar-upload {
            text-align: center;
            margin-bottom: 20px;
        }

        .avatar-upload label {
            display: inline-block;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: var(--container-bg);
            border: 2px dashed var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .avatar-upload label:hover {
            background-color: var(--border-color);
            border-color: var(--upload-icon-color);
        }

        .avatar-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .avatar-upload input[type="file"] {
            display: none;
        }

        .avatar-upload .upload-icon {
            font-size: 24px;
            color: var(--upload-icon-color);
        }

        .delete-btn {
            background-color: var(--delete-btn-bg);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }

        .delete-btn:hover {
            background-color: var(--delete-btn-hover-bg);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
        #crop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        #crop-container {
            width: 400px;
            height: 400px;
            max-width: 90vw;
            max-height: 90vh;
        }

        #crop-image {
            max-width: 100%;
            max-height: 100%;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--button-bg);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* –ö—Ä—É–≥–ª—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        button {
            margin-bottom: 15px;
        }

        h2 {
            text-align: center;
            font-size: 30px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .settings-container {
                padding: 15px;
                margin: 10px;
            }

            .avatar-upload label {
                width: 120px;
                height: 120px;
            }
        }

        /* –¢–µ–º–Ω—ã–π —Ä–µ–∂–∏–º */
        body.dark-mode {
            background-color: var(--bg-color);
            color: var(--text-color); /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
        }

        body.dark-mode .settings-container {
            background-color: var(--container-bg);
            color: var(--text-color); /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
        }

        body.dark-mode .avatar-upload label {
            background-color: var(--container-bg);
            border-color: var(--border-color);
        }

        body.dark-mode .avatar-upload label:hover {
            background-color: var(--border-color);
            border-color: var(--upload-icon-color);
        }

        body.dark-mode .upload-icon {
            color: var(--upload-icon-color);
        }

        body.dark-mode .delete-btn {
            background-color: var(--delete-btn-bg);
        }

        body.dark-mode .delete-btn:hover {
            background-color: var(--delete-btn-hover-bg);
        }

        body.dark-mode .slider {
            background-color: var(--border-color);
        }

        body.dark-mode input:checked + .slider {
            background-color: var(--button-bg);
        }

        /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤–µ—Å—å —Ç–µ–∫—Å—Ç –≤ —Ç–µ–º–Ω–æ–º —Ä–µ–∂–∏–º–µ –±–µ–ª—ã–π */
        body.dark-mode * {
            color: var(--text-color) !important; /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        }
    </style>
</head>
<body>
    <div class="settings-container">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>

        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞ -->
            <div class="avatar-upload">
                <label for="avatar-upload">
                    {% if user.avatar %}
                        <img src="{{ url_for('static', filename=user.avatar) }}" alt="–ê–≤–∞—Ç–∞—Ä">
                    {% else %}
                        <span class="upload-icon">üìÅ</span>
                    {% endif %}
                </label>
                <input type="file" id="avatar-upload" name="avatar" accept="image/*" onchange="handleAvatarUpload(event)">
                <input type="hidden" name="cropped_avatar">
                <input type="hidden" name="crop_data">
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã -->
            <div class="form-group">
                <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" name="username" value="{{ user.username }}" required>
            </div>

            <div class="form-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea name="description" rows="4">{{ user.description }}</textarea>
            </div>

            <div class="form-group">
                <label>–¢–µ–º–Ω—ã–π —Ä–µ–∂–∏–º:</label>
                <label class="switch">
                    <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()" {% if current_user.dark_mode %}checked{% endif %}>
                    <span class="slider round"></span>
                </label>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –≤ –∫–æ–Ω—Ü–µ —Ñ–æ—Ä–º—ã -->
            <div class="form-group">
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                <button type="button" onclick="confirmDelete()" class="delete-btn">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>
        </form>

        <!-- –°–∫—Ä—ã—Ç–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è -->
        <form id="deleteForm" method="POST" action="{{ url_for('delete_account', user_id=current_user.id) }}" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        </form>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="crop-modal">
        <div style="background: var(--container-bg); padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%;">
            <div id="crop-container">
                <img id="crop-image" src="" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è">
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="cropImage()" style="background: var(--button-bg); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">–û–±—Ä–µ–∑–∞—Ç—å</button>
                <button onclick="closeCropModal()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-left: 10px;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div style="height: 100px;"></div> <!-- –ü—É—Å—Ç–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ -->

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Cropper.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
        let cropper;

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
        function openCropModal(imageSrc) {
            const cropModal = document.getElementById('crop-modal');
            const cropImage = document.getElementById('crop-image');
            cropImage.src = imageSrc;
            cropModal.style.display = 'flex';

            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä Cropper
            if (cropper) {
                cropper.destroy();
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Cropper.js
            cropper = new Cropper(cropImage, {
                aspectRatio: 1, // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω 1:1 (–∫–≤–∞–¥—Ä–∞—Ç)
                viewMode: 1, // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                autoCropArea: 1, // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–π –æ–±–ª–∞—Å—Ç–∏
                movable: true, // –†–∞–∑—Ä–µ—à–∏—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                zoomable: true, // –†–∞–∑—Ä–µ—à–∏—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
                rotatable: false, // –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –≤—Ä–∞—â–µ–Ω–∏–µ
                scalable: false, // –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
                cropBoxMovable: true, // –†–∞–∑—Ä–µ—à–∏—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
                cropBoxResizable: true, // –†–∞–∑—Ä–µ—à–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ–±–ª–∞—Å—Ç–∏ –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeCropModal() {
            const cropModal = document.getElementById('crop-modal');
            cropModal.style.display = 'none';
            if (cropper) {
                cropper.destroy(); // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º Cropper.js
            }
        }

        // –û–±—Ä–µ–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function cropImage() {
            if (cropper) {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± –æ–±–ª–∞—Å—Ç–∏ –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
                const cropData = cropper.getData();

                // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
                const oldInput = document.querySelector('input[name="cropped_avatar"]');
                if (oldInput) oldInput.remove();

                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                const croppedCanvas = cropper.getCroppedCanvas();
                const croppedImage = croppedCanvas.toDataURL('image/jpeg');
                const avatarLabel = document.querySelector('.avatar-upload label');
                const newImg = new Image();
                newImg.src = croppedImage;
                newImg.onload = () => {
                    avatarLabel.innerHTML = '';
                    avatarLabel.appendChild(newImg);
                };

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'cropped_avatar';
                hiddenInput.value = croppedImage;
                document.querySelector('form').appendChild(hiddenInput);

                // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± –æ–±–ª–∞—Å—Ç–∏ –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
                const cropDataInput = document.createElement('input');
                cropDataInput.type = 'hidden';
                cropDataInput.name = 'crop_data';
                cropDataInput.value = JSON.stringify(cropData);
                document.querySelector('form').appendChild(cropDataInput);

                closeCropModal();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞
        function handleAvatarUpload(event) {
            const file = event.target.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    openCropModal(e.target.result); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
                };
                reader.readAsDataURL(file);
            } else {
                // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω
                const avatarLabel = document.querySelector('.avatar-upload label');
                avatarLabel.innerHTML = '<span class="upload-icon">üìÅ</span>';
            }
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
        function confirmDelete() {
            if (confirm('–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                document.getElementById('deleteForm').submit();
            }
        }
    </script>
</body>
</html>
{% endblock %}